<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Input Form</title>
    <style>
        .form-container {
            max-width: 400px;
            margin: 50px auto;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
        }

        input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background-color: #45a049;
        }
    </style>
</head>

<body>
    <div style="display: flex; justify-content: space-around;">
        <div class="form-container">
            <div id="currentUser" style="display: none; margin-bottom: 15px;">
                <h3>Current User: <span id="currentUsername"></span></h3>
            </div>
            <form id="userForm">
                <div class="form-group">
                    <label for="username">Username:</label>
                    <input type="text" id="username" name="username" required>
                </div>
                <button type="button" id="submitName">Submit Name</button>

                <div class="form-group">
                    <label for="number">Enter a number:</label>
                    <input type="number" id="number" name="number" required>
                </div>
                <button type="button" id="sendMoney">Send Money</button>
            </form>
        </div>
        <div class="form-container">
            <h3>Other Users</h3>
            <div id="otherUsers">
            </div>
        </div>
        
    </div>
   
    <label for="users_label">Choose a user:</label>
    <select name="users" id="users_dropdown">
        <script>
            const usersOnline = document.getElementById('otherUsers').querySelectorAll('.user-entry');
            usersOnline.forEach(entry => {
                const username = entry.querySelector('p:first-child').textContent.split(':')[1].trim();
                document.write(`<option value="${username}">${username}</option>`);
            });
        </script>
    </select>


    <script>


        function updateUserDropdown(){ // once we touch the submit button we will update the dropdown to include the new information
            const selectElement = document.getElementById('users_dropdown');
            selectElement.innerHTML = ''; // Clear existing options

            const userEntries = document.querySelectorAll('.user-entry');


            userEntries.forEach(entry => {
                const username = entry.querySelector('p:first-child').textContent.split(':')[1].trim();
                const option = document.createElement('option');
                option.value = username;
                option.textContent = username;
                selectElement.appendChild(option);
            });
        }

        updateUserDropdown();

        document.getElementById('submitName').addEventListener('click', function() {
            const username = document.getElementById('username').value;
            
            // Display current user
            document.getElementById('currentUser').style.display = 'block';
            document.getElementById('currentUsername').textContent = username;
            
            // Disable username input and submit button after submission
            document.getElementById('username').disabled = true;
            document.getElementById('submitName').disabled = true;
            
            // Send username to WebSocket server
            socket.send(JSON.stringify({
                type: 'username',
                username: username
            }));
            
            const userEntry = document.createElement('div');
            userEntry.className = 'user-entry';
            userEntry.innerHTML = `
                <p><strong>Username:</strong> ${username}</p>
                <p><strong>Number:</strong> 0</p>
            `;
            
            document.getElementById('otherUsers').appendChild(userEntry);
            updateUserDropdown();
        });

        document.getElementById('sendMoney').addEventListener('click', function() {
            const selectedUser = document.getElementById('users_dropdown').value;
            const amountInput = document.getElementById('number');
            const amountToAdd = parseInt(amountInput.value);

            if (!selectedUser) {
                alert('Please select a user to send money to');
                return;
            }

            if (!amountToAdd || isNaN(amountToAdd)) {
                alert('Please enter a valid number');
                return;
            }

            // Show loading state
            const sendButton = this;
            sendButton.disabled = true;
            sendButton.textContent = 'Encrypting...';

            // Send money update to WebSocket server
            socket.send(JSON.stringify({
                type: 'money',
                username: selectedUser,
                amount: amountToAdd
            }));

            // Reset form and button
            setTimeout(() => {
                amountInput.value = '';
                sendButton.disabled = false;
                sendButton.textContent = 'Send Money';
            }, 1000);
        });

        // Create WebSocket connection
        const socket = new WebSocket('ws://localhost:8080');

        socket.onmessage = function(event) {
            const data = JSON.parse(event.data);
            console.log('Received websocket message:', data); // Debug log
            
            if (data.type === 'users') {
                // Handle initial users list
                data.users.forEach(username => {
                    if (username) {
                        const userEntry = document.createElement('div');
                        userEntry.className = 'user-entry';
                        userEntry.innerHTML = `
                            <p><strong>Username:</strong> ${username}</p>
                            <p><strong>Number:</strong> 0</p>
                            <p class="encryption-status" style="display: none;">Transaction encrypted and verified</p>
                        `;
                        document.getElementById('otherUsers').appendChild(userEntry);
                    }
                });
                updateUserDropdown();
            } else if (data.type === 'username') {
                // Handle new user
                const userEntry = document.createElement('div');
                userEntry.className = 'user-entry';
                userEntry.innerHTML = `
                    <p><strong>Username:</strong> ${data.username}</p>
                    <p><strong>Number:</strong> 0</p>
                    <p class="encryption-status" style="display: none;">Transaction encrypted and verified</p>
                `;
                document.getElementById('otherUsers').appendChild(userEntry);
                updateUserDropdown();
            } else if (data.type === 'money') {
                console.log('Processing money update:', data); // Debug log
                const userEntries = document.querySelectorAll('.user-entry');
                userEntries.forEach(entry => {
                    const username = entry.querySelector('p:first-child').textContent.split(':')[1].trim();
                    if (username === data.username) {
                        const numberElement = entry.querySelector('p:nth-child(2)');
                        const currentAmount = parseInt(numberElement.textContent.split(':')[1].trim()) || 0;
                        const newAmount = currentAmount + data.amount;
                        numberElement.innerHTML = `<strong>Number:</strong> ${newAmount}`;
                        
                        // Show encryption status
                        const statusElement = entry.querySelector('.encryption-status');
                        statusElement.style.display = 'block';
                        statusElement.textContent = `Transaction encrypted (${data.encryptedAmount}) and verified`;
                        setTimeout(() => {
                            statusElement.style.display = 'none';
                        }, 3000);
                    }
                });
            }
        };

    </script>
</body>

</html>